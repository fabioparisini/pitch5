<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SARA - Seamless AI Reliable Assistant</title>
    <style>
        /* --- FONTS & GLOBAL STYLES --- */
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Poppins:wght@300;400;500&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css');

        :root {
            --primary-bg: #FDFDFD;
            --secondary-bg: #F4F4F4;
            --primary-text: #1A1A1A;
            --secondary-text: #666;
            --accent-color: #004D40; /* A deep, luxurious green */
            --border-color: #E0E0E0;
            --font-heading: 'Cormorant Garamond', serif;
            --font-body: 'Poppins', sans-serif;
        }

        body {
            margin: 0;
            font-family: var(--font-body);
            background-color: var(--primary-bg);
            color: var(--primary-text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-container { display: flex; flex-direction: column; height: 100%; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; border-bottom: 1px solid var(--border-color); background-color: var(--primary-bg); flex-shrink: 0; }
        main { flex-grow: 1; overflow-y: auto; padding: 20px 30px; }
        footer { flex-shrink: 0; border-top: 1px solid var(--border-color); background-color: var(--primary-bg); padding: 15px 30px; }

        /* --- HEADER ELEMENTS --- */
        .sara-logo { font-family: var(--font-heading); font-size: 28px; font-weight: 700; letter-spacing: 2px; }
        .user-profile { display: flex; align-items: center; gap: 20px; position: relative; }
        .user-info .name { font-weight: 500; }
        .user-info .role { font-size: 0.8em; color: var(--secondary-text); }
        .user-profile img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
        .task-icon { font-size: 24px; cursor: pointer; color: var(--primary-text); transition: color 0.2s; }
        .task-icon:hover { color: var(--accent-color); }

        /* --- TASK LIST DROPDOWN --- */
        #task-list { display: none; position: absolute; top: 60px; right: 0; width: 300px; background-color: white; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; z-index: 100; }
        #task-list.active { display: block; }
        #task-list h3 { font-family: var(--font-heading); padding: 15px; margin: 0; border-bottom: 1px solid var(--border-color); }
        #task-list ul { list-style: none; padding: 0; margin: 0; }
        #task-list li { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 0.9em; }
        #task-list li:last-child { border-bottom: none; }
        #task-list li::before { content: '\f0a4'; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 10px; color: var(--accent-color); }

        /* --- CHAT AREA --- */
        #chat-window { display: flex; flex-direction: column; gap: 20px; }
        .chat-message { max-width: 80%; padding: 15px; border-radius: 12px; line-height: 1.5; }
        .user-message { background-color: var(--accent-color); color: white; align-self: flex-end; border-bottom-right-radius: 0; }
        .sara-message { background-color: var(--secondary-bg); align-self: flex-start; border-bottom-left-radius: 0; width: 100%; box-sizing: border-box; }
        .sara-message .intro-text { margin-bottom: 15px; font-weight: 500; }
        .sara-message ul { padding-left: 20px; margin-top: 0;}
        .sara-message h3 { font-family: var(--font-heading); margin-top: 0; }
        
        /* --- CUSTOMER PROFILE CARD --- */
        .customer-profile-card { border-left: 4px solid var(--accent-color); padding: 15px; background-color: #fafafa; }
        .customer-profile-card h3 { margin-bottom: 10px; }
        .customer-profile-card p { margin: 5px 0; font-size: 0.9em; }

        /* --- ENHANCED PRODUCT CARD --- */
        .product-proposal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .product-card { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background-color: white; transition: box-shadow 0.3s; display: flex; flex-direction: column; }
        .product-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .product-card .product-svg-placeholder { width: 100%; height: 220px; object-fit: cover; display: block; background-color: #f0f0f0; }
        .product-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .product-name { font-weight: 600; font-family: var(--font-heading); font-size: 1.3em; margin: 0 0 8px 0; }
        .product-reason { font-size: 0.9em; color: var(--primary-text); margin: 0 0 12px 0; border-left: 3px solid var(--accent-color); padding-left: 10px; font-style: italic; }
        .product-storytelling { font-size: 0.85em; color: var(--secondary-text); margin: 10px 0 12px 0; }
        /* NEW: Availability Section */
        .product-availability { font-size: 0.8em; margin: 0 0 15px 0; color: #333; padding: 10px; background-color: var(--secondary-bg); border-radius: 4px; }
        .product-availability div { margin-bottom: 4px; }
        .product-availability div:last-child { margin-bottom: 0; }
        .product-availability i { margin-right: 8px; color: var(--accent-color); width: 15px; text-align: center; }
        .cross-sell-section { margin-top: auto; padding-top: 15px; border-top: 1px dashed var(--border-color); }
        .cross-sell-section h5 { margin: 0 0 8px 0; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
        .cross-sell-items { display: flex; gap: 10px; flex-wrap: wrap; }
        .cross-sell-item { font-size: 0.8em; background-color: var(--secondary-bg); padding: 4px 8px; border-radius: 12px; cursor: pointer; }
        .cross-sell-item:hover { background-color: #ddd; }
        .product-actions { display: flex; align-items: center; gap: 10px; margin-top: 15px; }
        .quantity-input { width: 40px; padding: 8px; text-align: center; border: 1px solid var(--border-color); border-radius: 4px; }
        .add-to-basket-btn { flex-grow: 1; padding: 8px 12px; background-color: var(--primary-text); color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; font-size: 0.9em; }
        .add-to-basket-btn:hover { background-color: #333; }

        /* --- Other CSS --- */
        .basket-container{padding:10px}.basket-container h3{font-family:var(--font-heading);margin-bottom:15px}.basket-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border-color)}.basket-item:last-child{border-bottom:none}.basket-item-details{flex-grow:1}.basket-item-actions{display:flex;align-items:center;gap:10px}.basket-remove-btn{background:none;border:none;color:#a00;cursor:pointer;font-size:1.1em}#suggested-actions{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}.suggested-action-btn{padding:8px 15px;border:1px solid var(--border-color);background-color:white;border-radius:20px;cursor:pointer;font-size:.9em;transition:all .2s}.suggested-action-btn:hover{background-color:var(--secondary-bg);border-color:#ccc}#chat-form{display:flex;align-items:center;gap:15px}#chat-input{flex-grow:1;padding:12px 15px;border:1px solid var(--border-color);border-radius:25px;font-size:1em}#chat-input:focus{outline:none;border-color:var(--accent-color)}.input-icon{font-size:22px;cursor:pointer;color:var(--secondary-text);transition:color .2s}.input-icon:hover{color:var(--primary-text)}.input-icon.recording{color:#d32f2f}#send-btn{background-color:var(--accent-color);color:white;border:none;width:45px;height:45px;border-radius:50%;font-size:18px;cursor:pointer;transition:background-color .2s}#send-btn:hover{background-color:#00382f}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);align-items:center;justify-content:center}.modal.active{display:flex}.modal-content{background-color:white;padding:30px;border-radius:8px;width:90%;max-width:500px;text-align:center;position:relative}.modal-close-btn{position:absolute;top:10px;right:15px;font-size:28px;font-weight:700;color:#aaa;cursor:pointer;transition:color .2s}.modal-close-btn:hover{color:#333}.modal-content h2{font-family:var(--font-heading);margin-top:0}.modal-buttons{display:flex;justify-content:center;gap:15px;margin-top:25px}.modal-btn{padding:12px 25px;border-radius:6px;border:1px solid var(--accent-color);cursor:pointer;font-size:1em}.modal-btn-primary{background-color:var(--accent-color);color:white}.modal-btn-secondary{background-color:white;color:var(--accent-color)}#barcode-scanner-view{width:100%;height:250px;background:#333;position:relative;overflow:hidden;border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:1.2em}#barcode-scanner-view .scan-line{position:absolute;left:0;width:100%;height:2px;background:#00ff00;box-shadow:0 0 10px #00ff00;animation:scan 2s infinite linear}@keyframes scan{0%{top:0}50%{top:100%}100%{top:0}}
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="sara-logo">SARA</div>
            <div class="user-profile"></div>
        </header>
        <main id="main-content">
            <div id="chat-window"></div>
        </main>
        <footer></footer>
    </div>

    <!-- MODAL INJECTIONS -->
    <!-- The JavaScript below will inject all modal HTML -->
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATABASE & STATE SIMULATION ---
        const productCatalogue = [
            { id: 'BV001', name: 'Small Andiamo', category: 'Bag', color: 'brown', keywords: ['andiamo', 'small', 'bag', 'brown', 'work'], price: '€ 3,500', stock: { store: 10, city: 5, omnichannel: 3 }, storytelling: 'The Andiamo, meaning "Let\'s go" in Italian, embodies a go-anywhere spirit.', useCases: { work: "It's an excellent choice for work. The structured shape is professional, and it's spacious enough for essentials without being too large.", default: "A signature piece defined by clean lines and the iconic Intrecciato weave." }, crossSellOptions: ['BV004', 'BV010'] },
            { id: 'BV002', name: 'Mini Jodie', category: 'Bag', color: 'pink', keywords: ['jodie', 'mini', 'bag', 'pink'], price: '€ 2,200', stock: { store: 10, city: 5, omnichannel: 3 }, storytelling: 'A playful, micro version of the iconic Jodie.', useCases: { default: "The Jodie's knotted silhouette is instantly recognizable." }, crossSellOptions: [] },
            { id: 'BV003', name: 'Large Hop', category: 'Bag', color: 'brown', keywords: ['hop', 'large', 'bag', 'brown', 'hobo', 'work', 'laptop'], price: '€ 4,200', stock: { store: 10, city: 5, omnichannel: 3 }, storytelling: 'Inspired by a 2002 hobo design, the Hop bag features a seamless, pyramidal shape.', useCases: { work: "This is a perfect choice for work, especially if she needs to carry her laptop. The soft, spacious design combines comfort and capacity.", laptop: "The Large Hop is ideal for carrying a laptop; its hobo shape accommodates larger devices comfortably while remaining stylish.", default: "This bag's beauty lies in its seamless construction." }, crossSellOptions: ['BV006', 'BV010'] },
            { id: 'BV004', name: 'Cassette Wallet', category: 'Wallet', color: 'brown', keywords: ['cassette', 'wallet', 'brown', 'card'], price: '€ 590', stock: { store: 10, city: 5, omnichannel: 3 }, storytelling: 'The orthogonal weave of the Cassette is a modern classic.', useCases: { default: 'A perfect companion piece, featuring the iconic Cassette weave.' }, crossSellOptions: [] },
            { id: 'BV005', name: 'Orbit Sneaker', category: 'Woman Shoes', color: 'white', keywords: ['orbit', 'sneaker', 'shoes', 'white', 'silver'], price: '€ 790', stock: { store: 10, city: 5, omnichannel: 3 }, storytelling: 'A lightweight \'runner\' sneaker blending athletic inspiration with luxury.', useCases: { default: "A great example of blending high-fashion aesthetics with everyday comfort." }, crossSellOptions: [] },
            { id: 'BV006', name: 'Canalazzo Mule', category: 'Shoes', color: 'black', keywords: ['canalazzo', 'mule', 'shoes', 'black', 'heel', 'evening'], price: '€ 1,200', stock: { store: 10, city: 5, omnichannel: 3 }, storytelling: 'Featuring a sculptural heel and a clean silhouette.', useCases: { default: 'The clean lines and unique heel make this a sophisticated choice.'}, crossSellOptions: [] },
            { id: 'BV009', name: 'Large Andiamo', category: 'Bag', color: 'brown', keywords: ['andiamo', 'large', 'bag', 'brown', 'work', 'laptop'], price: '€ 5,800', stock: { store: 10, city: 5, omnichannel: 3 }, storytelling: 'The ultimate expression of the Andiamo, offering maximum capacity and versatility.', useCases: { work: 'For a powerful work statement, the Large Andiamo is unmatched. It has a commanding presence and ample space for a laptop and all daily necessities.', laptop: 'This bag is perfectly suited for a laptop and documents.', default: 'The ultimate expression of the Andiamo.' }, crossSellOptions: ['BV004', 'BV010'] },
            { id: 'BV010', name: 'Stirrup Charm', category: 'Charm', color: 'gold', keywords: ['charm', 'gold', 'stirrup', 'accessory'], price: '€ 450', stock: { store: 10, city: 5, omnichannel: 3 }, storytelling: 'A small, sculptural accessory that adds a personalized touch of elegance.', useCases: { default: 'A small accessory to add a personalized touch.' }, crossSellOptions: [] },
        ];
        
        const customers = [ 
            { id: 1, name: 'Marco Citterio', profileSummary: 'Prefers classic, understated pieces. Values craftsmanship.', purchaseHistory: [] }, 
            { id: 2, name: 'Marta Citterio', profileSummary: 'Enjoys seasonal colors and more trend-focused items.', purchaseHistory: [] }, 
            { id: 3, name: 'Francesco Lanzoni', profileSummary: 'Buys functional, everyday luxury items. Focus on leather goods.', purchaseHistory: [] }, 
            { id: 4, name: 'Anais Levy', profileSummary: 'Loves iconic bags and is building her collection. Open to new shapes.', purchaseHistory: ['BV002', 'BV001', 'BV005'] }, 
            { id: 5, name: 'Julia Bevilacqua', profileSummary: 'Client with a focus on evening wear and special occasion pieces.', purchaseHistory: [] }, 
            { id: 6, name: 'Federica Lanzoni', profileSummary: 'Interested in versatile pieces that can be dressed up or down.', purchaseHistory: [] },
            { id: 7, name: 'Andrea Moretti', profileSummary: 'New client, first visit to the store.', purchaseHistory: [] },
            { id: 8, name: 'Alexandre Schannes', profileSummary: 'Focuses on travel gear and practical accessories.', purchaseHistory: [] },
            { id: 9, name: 'Ariel Musicant', profileSummary: 'Interested in small leather goods and unique accessories.', purchaseHistory: ['BV010'] }
        ];
        
        const userTasks = ["Recontact customer Lanzoni for the new collection.", "Remember to customer Bevilacqua that we have the new Andiamo in store."];
        let basket = [];
        let activeCustomer = null;
        let itemToAdd = {};

        // --- DYNAMIC HTML INJECTION & DOM ELEMENTS SETUP ---
        const injectHTML = () => {
            document.querySelector('.user-profile').innerHTML = `<div class="user-info"><div class="name">Gemma</div><div class="role">Client Advisor</div></div><img src="https://images.pexels.com/photos/3760852/pexels-photo-3760852.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500" alt="User Picture"><i id="task-icon" class="fas fa-clipboard-list task-icon"></i><div id="task-list"><h3>Pending Tasks</h3><ul></ul></div>`;
            document.querySelector('footer').innerHTML = `<div id="suggested-actions"><button id="review-basket-btn" class="suggested-action-btn"><i class="fas fa-shopping-basket"></i> Review Basket</button><button id="add-customer-btn" class="suggested-action-btn"><i class="fas fa-user-plus"></i> Add Customer</button><button id="checkout-btn" class="suggested-action-btn"><i class="fas fa-credit-card"></i> Basket Checkout</button><button id="share-btn" class="suggested-action-btn"><i class="fas fa-share-alt"></i> Share Curated Selection</button></div><form id="chat-form"><input type="text" id="chat-input" placeholder="Ask SARA..." autocomplete="off"><i id="barcode-btn" class="fas fa-barcode input-icon"></i><i id="tts-btn" class="fas fa-microphone input-icon"></i><button type="submit" id="send-btn"><i class="fas fa-paper-plane"></i></button></form>`;
            
            // --- MODALS ---
            const modals = `
                <div id="pos-luce-modal" class="modal">
                    <div class="modal-content">
                        <span class="modal-close-btn">&times;</span>
                        <h2>Add to Basket</h2>
                        <p>Where should this item be added?</p>
                        <div class="modal-buttons">
                            <button id="add-to-pos-btn" class="modal-btn modal-btn-primary">Add to POS</button>
                            <button id="add-to-luce-btn" class="modal-btn modal-btn-secondary">Add to LUCE</button>
                        </div>
                    </div>
                </div>
                <div id="barcode-modal" class="modal">
                    <div class="modal-content">
                        <span class="modal-close-btn">&times;</span>
                        <h2>Scan Barcode</h2>
                        <p>Point your camera at a product barcode.</p>
                        <div id="barcode-scanner-view">
                            <div class="scan-line"></div>
                            Simulating Camera Feed...
                        </div>
                        <div class="modal-buttons">
                            <button id="cancel-scan-btn" class="modal-btn modal-btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
                <div id="customer-modal" class="modal">
                    <div class="modal-content">
                        <span class="modal-close-btn">&times;</span>
                        <h2>Add Customer</h2>
                        <input type="text" id="customer-search-input" placeholder="Search customer by name..." style="width: 80%; padding: 10px; margin-top: 10px;">
                        <div id="customer-search-results" style="margin-top: 15px; text-align: left;"></div>
                    </div>
                </div>
                <div id="share-modal" class="modal">
                    <div class="modal-content">
                        <span class="modal-close-btn">&times;</span>
                        <h2>Share Selection</h2>
                        <p>How would you like to share?</p>
                        <div class="modal-buttons">
                            <button onclick="displayAlert('Sharing Initiated', 'Your curated selection is ready to be shared via WhatsApp.'); closeModal('#share-modal')" class="modal-btn modal-btn-primary"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                            <button onclick="displayAlert('Sharing Initiated', 'Your curated selection is ready to be shared via WeChat.'); closeModal('#share-modal')" class="modal-btn modal-btn-primary"><i class="fab fa-weixin"></i> WeChat</button>
                            <button onclick="displayAlert('Sharing Initiated', 'Your curated selection is ready to be shared via Email.'); closeModal('#share-modal')" class="modal-btn modal-btn-primary"><i class="fas fa-envelope"></i> Email</button>
                        </div>
                    </div>
                </div>
                <!-- Custom Info/Alert Modal (Replaces browser alert()) -->
                <div id="info-modal" class="modal">
                    <div class="modal-content">
                        <span class="modal-close-btn" onclick="closeModal('#info-modal')">&times;</span>
                        <h2 id="info-modal-title">Notification</h2>
                        <p id="info-modal-message">Message content.</p>
                        <div class="modal-buttons">
                            <button onclick="closeModal('#info-modal')" class="modal-btn modal-btn-primary">OK</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modals);
        };
        injectHTML();
        const getEl = (id) => document.getElementById(id);
        let chatWindow, mainContent, chatForm, chatInput, taskIcon, taskList, taskListUl, customerSearchInput, customerSearchResults;
        const assignElements = () => { chatWindow = getEl('chat-window'); mainContent = getEl('main-content'); chatForm = getEl('chat-form'); chatInput = getEl('chat-input'); taskIcon = getEl('task-icon'); taskList = getEl('task-list'); taskListUl = taskList.querySelector('ul'); customerSearchInput = getEl('customer-search-input'); customerSearchResults = getEl('customer-search-results'); };
        assignElements();

        // --- CORE FUNCTIONS ---
        const openModal = (s) => document.querySelector(s).classList.add('active');
        const closeModal = (s) => document.querySelector(s).classList.remove('active');
        
        // Custom alert function replacing browser alert()
        const displayAlert = (title, message) => {
            getEl('info-modal-title').textContent = title;
            getEl('info-modal-message').textContent = message;
            openModal('#info-modal');
        };

        const addMessageToChat = (text, sender) => { const m = document.createElement('div'); m.classList.add('chat-message', `${sender}-message`); m.innerHTML = text; chatWindow.appendChild(m); mainContent.scrollTop = mainContent.scrollHeight; };
        const generateSvgPlaceholder = (p) => { const cM={green:'#004D40',pink:'#E6A8D7',black:'#1A1A1A',brown:'#8B4513',silver:'#C0C0C0',gold:'#FFD700',white:'#F5F5F5'},bC=cM[p.color.toLowerCase()]||'#ccc',tC=['white','silver','gold','pink'].includes(p.color.toLowerCase())?'#1A1A1A':'#FFF'; return `data:image/svg+xml;base64,${btoa(`<svg class="product-svg-placeholder" viewBox="0 0 280 220" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="${bC}"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="${tC}" font-family="Cormorant Garamond, serif" font-size="28">${p.category}</text></svg>`)}`;};
        const generateReason = (p, prompt) => { const lP=prompt.toLowerCase(); for (const uC in p.useCases) { if (lP.includes(uC)) return p.useCases[uC]; } return p.useCases.default; };
        
        const addProductProposalToChat = (introText, products) => {
            let html = products.map(p => {
                const reason = generateReason(p, chatInput.value || "");
                const imgSrc = generateSvgPlaceholder(p);
                const crossSellHtml = p.crossSellOptions.map(id => {
                    const crossSellProduct = productCatalogue.find(csp => csp.id === id);
                    return crossSellProduct ? `<span class="cross-sell-item">${crossSellProduct.name}</span>` : '';
                }).join('');

                return `<div class="product-card">
                            <img src="${imgSrc}" alt="${p.name}" class="product-svg-placeholder">
                            <div class="product-info">
                                <h3 class="product-name">${p.name}</h3>
                                <div class="product-reason">${reason}</div>
                                <div class="product-storytelling">${p.storytelling}</div>
                                <div class="product-availability">
                                    <div><i class="fas fa-store"></i>In Store: <strong>${p.stock.store}</strong></div>
                                    <div><i class="fas fa-city"></i>City: <strong>${p.stock.city}</strong></div>
                                    <div><i class="fas fa-globe"></i>Omni: <strong>${p.stock.omnichannel}</strong></div>
                                </div>
                                <div class="cross-sell-section">
                                    <h5>Complete the Look:</h5>
                                    <div class="cross-sell-items">${crossSellHtml || 'None'}</div>
                                </div>
                                <div class="product-actions">
                                    <input type="number" class="quantity-input" value="1" min="1" max="10" data-product-id="${p.id}">
                                    <button class="add-to-basket-btn" data-product-id="${p.id}">Add to Basket</button>
                                </div>
                            </div>
                        </div>`;
            }).join('');
            addMessageToChat(`<div class="intro-text">${introText}</div><div class="product-proposal-grid">${html}</div>`, 'sara');
        };

        const processPrompt = (prompt) => {
            const lowerPrompt = prompt.toLowerCase();
            addMessageToChat(prompt, 'user');
            chatInput.value = '';
            setTimeout(() => {
                if (lowerPrompt.includes('hello') || lowerPrompt.includes('hi')) { addMessageToChat(`Hello! ${activeCustomer ? `I see you're assisting ${activeCustomer.name}. ` : ''}How can I help?`, 'sara'); return; }
                const promptKeywords = lowerPrompt.split(' ').filter(word => word.length > 3);
                const scoredProducts = productCatalogue.map(product => {
                    let score = 0;
                    promptKeywords.forEach(pk => { if (product.keywords.includes(pk)) score += 1; });
                    return { product, score };
                }).filter(item => item.score > 0).sort((a, b) => b.score - a.score);
                const matchingProducts = scoredProducts.map(item => item.product);
                if (matchingProducts.length > 0) { addProductProposalToChat("Based on your request, here is a curated selection:", matchingProducts.slice(0, 3)); } 
                else { addMessageToChat("I'm sorry, I couldn't find specific products matching your request. Could you please try rephrasing?", 'sara'); }
            }, 800);
        };
        
        const showCustomerProfile = (customer) => {
            const historyItems = customer.purchaseHistory.map(id => {
                const product = productCatalogue.find(p => p.id === id);
                return product ? `<li>${product.name} (${product.category})</li>` : '';
            }).join('');
            const profileHtml = `
                <div class="customer-profile-card">
                    <h3>Client Overview: ${customer.name}</h3>
                    <p><strong>Profile Notes:</strong> ${customer.profileSummary}</p>
                    <p><strong>Previous Purchases:</strong></p>
                    <ul>${historyItems || '<li>No purchase history on file.</li>'}</ul>
                </div>`;
            addMessageToChat(profileHtml, 'sara');
        };
        
        const displayInteractiveBasket = () => { let id='b-msg';if(basket.length===0){addMessageToChat("The basket is empty.",'sara',id);return;} let n=activeCustomer?activeCustomer.name:'the current session'; let h=basket.map(i=>{let p=productCatalogue.find(pr=>pr.id===i.productId);return`<div class="basket-item"><div class="basket-item-details"><strong>${p.name}</strong> (${p.price})</div><div class="basket-item-actions">Qty: <input type="number" class="quantity-input" value="${i.quantity}" min="1" max="10" data-product-id="${p.id}"> <button class="basket-remove-btn" data-product-id="${p.id}"><i class="fas fa-trash-alt"></i></button></div></div>`}).join(''); addMessageToChat(`<div class="basket-container"><h3>Basket for ${n}</h3>${h}</div>`,'sara',id);};
        const confirmAddToCart = (system) => { basket.push({...itemToAdd, system}); const p=productCatalogue.find(pr=>pr.id===itemToAdd.productId); addMessageToChat(`<em>Confirmed: Added ${itemToAdd.quantity} x ${p.name} to ${system}.</em>`,'sara'); closeModal('#pos-luce-modal'); updateBasketButton(); itemToAdd={};};
        const updateBasketButton = () => {const b=getEl('review-basket-btn');const t=basket.reduce((s,i)=>s+i.quantity,0);b.innerHTML=`<i class="fas fa-shopping-basket"></i> Review Basket${t>0?` (${t})`:''}`;};
        
        // --- EVENT LISTENERS & HANDLERS ---
        const setupEventListeners = () => {
            document.body.addEventListener('submit', (e) => { if (e.target.id === 'chat-form') { e.preventDefault(); const p = chatInput.value.trim(); if (p) processPrompt(p); } });
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('.modal-close-btn') || target.id === 'cancel-scan-btn') { target.closest('.modal')?.classList.remove('active'); return; }
                const actionBtn = target.closest('.suggested-action-btn');
                if (actionBtn) {
                    const id = actionBtn.id;
                    if(id === 'review-basket-btn') displayInteractiveBasket();
                    if(id === 'add-customer-btn') openModal('#customer-modal');
                    if(id === 'checkout-btn'){
                        // Replaced alert()
                        if(basket.length===0){displayAlert("Cannot Checkout", "The basket is empty."); return;}
                        addMessageToChat(`<em>Checkout initiated. Please proceed with payment on the POS.</em>`,'sara'); basket=[];updateBasketButton();
                    }
                    if(id === 'share-btn'){
                        // Replaced alert()
                        if(!activeCustomer){displayAlert("Cannot Share", "Please select an active customer before sharing a selection."); return;}
                        if(basket.length===0){displayAlert("Cannot Share", "The basket is empty. Please add items first."); return;}
                        openModal('#share-modal');
                    }
                }
                if (target.closest('#task-icon')) taskList.classList.toggle('active');
                if (target.closest('#barcode-btn')) { 
                    openModal('#barcode-modal'); 
                    // Simulate scan delay
                    setTimeout(() => { 
                        closeModal('#barcode-modal'); 
                        const p = productCatalogue.find(p => p.id === 'BV005'); 
                        addMessageToChat(`<em>Scanned barcode for: ${p.name}</em>`, 'user'); 
                        setTimeout(() => addProductProposalToChat("I've found the scanned item:", [p]), 500); 
                    }, 3000); 
                }
            });
            chatWindow.addEventListener('click', (e) => { 
                const t = e.target; 
                if (t.classList.contains('add-to-basket-btn')) { 
                    const pId=t.dataset.productId; 
                    const q=parseInt(t.closest('.product-card').querySelector('.quantity-input').value,10); 
                    itemToAdd={productId:pId,quantity:q}; 
                    openModal('#pos-luce-modal'); 
                } 
                if (t.closest('.basket-remove-btn')) { 
                    const pId=t.closest('.basket-remove-btn').dataset.productId; 
                    basket.splice(basket.findIndex(i=>i.productId===pId),1); 
                    updateBasketButton(); 
                    displayInteractiveBasket(); 
                } 
            });
            chatWindow.addEventListener('change', (e) => { 
                const t=e.target; 
                if(t.classList.contains('quantity-input')&&t.closest('.basket-item')){
                    const pId=t.dataset.productId; 
                    const nQ=parseInt(t.value,10); 
                    const item=basket.find(i=>i.productId===pId); 
                    if(item){
                        item.quantity=nQ; 
                        updateBasketButton();
                        displayInteractiveBasket();
                        addMessageToChat(`<em>Updated quantity.</em>`,'sara');
                    }
                }
            });
            getEl('add-to-pos-btn').addEventListener('click',()=>confirmAddToCart('POS')); 
            getEl('add-to-luce-btn').addEventListener('click',()=>confirmAddToCart('LUCE'));
            
            customerSearchResults.addEventListener('click', (e) => { 
                if(e.target.classList.contains('customer-result-item')){
                    activeCustomer=customers.find(c=>c.id===parseInt(e.target.dataset.customerId,10));
                    addMessageToChat(`<em>Active customer set to: <strong>${activeCustomer.name}</strong></em>`,'sara'); 
                    showCustomerProfile(activeCustomer); 
                    closeModal('#customer-modal');
                    customerSearchInput.value='';
                    customerSearchResults.innerHTML='';
                }
            });
            customerSearchInput.addEventListener('input', (e) => { 
                const q=e.target.value.toLowerCase(); 
                customerSearchResults.innerHTML=!q?'':customers.filter(c=>c.name.toLowerCase().includes(q)).map(c=>`<div style="padding:10px;cursor:pointer;border-bottom:1px solid #eee" data-customer-id="${c.id}" class="customer-result-item">${c.name}</div>`).join(''); 
            });

        };
        
        // --- INITIALIZATION ---
        const init = () => {
            assignElements();
            userTasks.forEach(t=>taskListUl.insertAdjacentHTML('beforeend',`<li>${t}</li>`));
            addMessageToChat("Welcome to SARA. How may I help you today?",'sara');
            setupEventListeners();
        };
        init();
    });
    </script>
</body>
</html>
